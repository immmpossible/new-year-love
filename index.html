<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>新年祝福</title>
  <style>
    html, body { margin: 0; width: 100%; height: 100%; overflow: hidden; background: #000000; color: #f8f5ff; }
    #scene-root, #fireworks-canvas { position: fixed; inset: 0; }
    #scene-root { z-index: 2; }
    #fireworks-canvas { z-index: 1; }
    .loading { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 12; padding: 10px 16px; border-radius: 999px; border: 1px solid rgba(255, 232, 190, 0.35); background: rgba(7, 10, 20, 0.7); color: #fff2d8; font-size: 13px; }
    .hidden { opacity: 0; visibility: hidden; }
    .music-btn { position: fixed; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom)); z-index: 14; border: 1px solid rgba(255, 221, 183, 0.45); color: #ffe7c7; background: rgba(12, 18, 34, 0.55); border-radius: 999px; padding: 10px 14px; }
  </style>
  <link rel="stylesheet" href="./style.css?v=20260216g" />
</head>
<body>
  <div id="scene-root"></div>
  <canvas id="fireworks-canvas"></canvas>

  <div id="loading" class="loading hidden">正在准备回忆照片...</div>

  <div id="love-note" class="love-note hidden" aria-live="polite">
    <p id="love-note-text" class="love-note-text"></p>
  </div>

  <button id="music-btn" class="music-btn" type="button" aria-label="播放或暂停音乐">
    播放音乐
  </button>

  <audio id="bgm" src="./assets/bgm.mp3?v=20260216g" preload="auto" loop></audio>

  <script>
    (function () {
      const threeSources = [
        "./assets/vendor/three.min.js?v=20260216g",
        "https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js",
        "https://unpkg.com/three@0.160.1/build/three.min.js"
      ];

      const orbitScriptSources = [
        "./assets/vendor/OrbitControls.global.js?v=20260216g"
      ];

      const orbitModuleSources = [
        "https://cdn.jsdelivr.net/npm/three@0.160.1/examples/jsm/controls/OrbitControls.js",
        "https://unpkg.com/three@0.160.1/examples/jsm/controls/OrbitControls.js"
      ];

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.async = false;
          s.onload = resolve;
          s.onerror = () => reject(new Error(`failed: ${src}`));
          document.head.appendChild(s);
        });
      }

      async function loadFirstScript(sources) {
        let lastError = null;
        for (const src of sources) {
          try {
            await loadScript(src);
            return src;
          } catch (err) {
            lastError = err;
          }
        }

        throw lastError || new Error("script load failed");
      }

      async function loadOrbitControlsFromModule(sources) {
        let lastError = null;
        for (const src of sources) {
          try {
            const resp = await fetch(src, { cache: "force-cache" });
            if (!resp.ok) {
              throw new Error(`fetch failed: ${src} (${resp.status})`);
            }

            let code = await resp.text();
            code = code.replace(
              /import[\s\S]*?from\s+['"]three['"];\s*/,
              "const { EventDispatcher, MOUSE, Quaternion, Spherical, TOUCH, Vector2, Vector3, Plane, Ray, MathUtils } = window.THREE;\n"
            );
            code = code.replace(
              /export\s*\{\s*OrbitControls\s*\};?\s*$/,
              "window.THREE.OrbitControls = OrbitControls;"
            );

            // eslint-disable-next-line no-new-func
            new Function(code)();
            if (!window.THREE || !window.THREE.OrbitControls) {
              throw new Error("OrbitControls not attached");
            }
            return src;
          } catch (err) {
            lastError = err;
          }
        }

        throw lastError || new Error("OrbitControls load failed");
      }

      window.__threeReady = (async () => {
        await loadFirstScript(threeSources);
        try {
          await loadFirstScript(orbitScriptSources);
        } catch (_) {
          await loadOrbitControlsFromModule(orbitModuleSources);
        }

        if (!window.THREE || !window.THREE.OrbitControls) {
          throw new Error("OrbitControls 注入失败");
        }
      })().catch((err) => {
        window.__threeLoadError = err;
      });
    })();
  </script>
  <script defer src="./main.js?v=20260216g"></script>
</body>
</html>
